<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D å°„å‡»ç”Ÿå­˜æ¸¸æˆ - ç»ˆæå¢å¼ºç‰ˆ</title>
    <!-- Umami ç»Ÿè®¡è„šæœ¬å»¶è¿ŸåŠ è½½å™¨ -->
    <script src="scripts/umami-loader.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #111;
            color: white;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }
        
        #gameContainer {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        
        #gameCanvas {
            border: 2px solid #333;
            background: #000;
        }
        
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
            min-width: 180px;
            width: 180px;
        }
        
        #rightPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 150;
            background: rgba(0,0,0,0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
            min-width: 200px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }
        
        #upgradeToggle {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 140;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        
        #upgradeToggle:hover {
            background: #45a049;
        }
        
        #upgradeToggle.has-points {
            background: #ff6600;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 102, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 102, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 102, 0, 0); }
        }
        
        .stat-bar {
            background: #333;
            height: 20px;
            border-radius: 10px;
            margin: 5px 0;
            overflow: hidden;
            border: 1px solid #555;
        }
        
        .health-fill { background: linear-gradient(90deg, #ff0000, #ff6666); }
        .exp-fill { background: linear-gradient(90deg, #0066ff, #66aaff); }
        .ammo-fill { background: linear-gradient(90deg, #ffaa00, #ffcc66); }
        
        .upgrade-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            position: relative;
            z-index: 160;
        }
        
        .upgrade-btn:hover {
            background: #45a049;
        }
        
        .upgrade-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .difficulty-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            font-size: 15px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: background 0.3s;
            margin: 3px;
            min-width: 110px;
        }
        
        .difficulty-btn:hover {
            background: #45a049;
        }
        
        .shoot-mode-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            margin: 3px;
            min-width: 90px;
            transition: all 0.3s;
        }
        
        .shoot-mode-btn:hover {
            background: #1976D2;
        }
        
        .shoot-mode-btn.active {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        
        .shoot-mode-btn:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        #instructions {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
        }
        
        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            text-align: center;
            background: rgba(0,0,0,0.9);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #666;
            display: none;
        }
        
        .restart-btn {
            background: #ff6600;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
        }
        
        .restart-btn:hover {
            background: #e55a00;
        }
        
        #pauseOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 130;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 48px;
            color: white;
        }
        
        #difficultySelect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 300;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .difficulty-panel {
            background: #222;
            border-radius: 15px;
            border: 2px solid #666;
            display: flex;
            gap: 15px;
            max-width: 95vw;
            max-height: 95vh;
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        .settings-left {
            flex: 0 0 50%;
            min-width: 320px;
            overflow-y: auto;
        }
        
        .settings-right {
            flex: 1;
            min-width: 400px;
            overflow-y: auto;
            max-height: 100%;
        }
        
        .difficulty-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin: 8px 0;
        }
        
        .shoot-mode-buttons {
            display: flex;
            gap: 6px;
            margin: 6px 0;
        }
        
        .powerup-guide {
            background: #333;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }
        
        .powerup-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
            padding: 6px;
            background: #444;
            border-radius: 4px;
            position: relative;
        }
        
        .powerup-emoji {
            font-size: 16px;
            margin-right: 8px;
            width: 24px;
            text-align: center;
        }
        
        .powerup-preview {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .invulnerable-preview {
            background: radial-gradient(circle, gold, #ffaa00);
            box-shadow: 0 0 10px gold;
            animation: invulnerable-pulse 1s infinite;
        }
        
        .time-slow-preview {
            background: radial-gradient(circle, cyan, #0088aa);
            box-shadow: 0 0 8px cyan;
            animation: time-slow-pulse 1.5s infinite;
        }
        
        .double-fire-preview {
            background: radial-gradient(circle, orange, #ff6600);
            box-shadow: 0 0 8px orange;
            animation: fire-pulse 0.8s infinite;
        }
        
        .piercing-preview {
            background: radial-gradient(circle, #9d4edd, #6a1b9a);
            box-shadow: 0 0 8px #9d4edd;
            animation: piercing-pulse 1.2s infinite;
        }
        
        .regen-preview {
            background: radial-gradient(circle, #00ff00, #008800);
            box-shadow: 0 0 8px #00ff00;
            animation: regen-pulse 1s infinite;
        }
        
        @keyframes invulnerable-pulse {
            0%, 100% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.2); }
        }
        
        @keyframes time-slow-pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        @keyframes fire-pulse {
            0%, 100% { box-shadow: 0 0 8px orange; }
            50% { box-shadow: 0 0 15px orange, 0 0 25px #ff6600; }
        }
        
        @keyframes piercing-pulse {
            0%, 100% { transform: translateY(-50%) rotate(0deg); }
            50% { transform: translateY(-50%) rotate(180deg); }
        }
        
        @keyframes regen-pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; transform: translateY(-50%) scale(1.1); }
        }
        
        .options-section {
            background: #333;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .probability-section {
            background: #333;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }
        
        .probability-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 4px 0;
            padding: 3px;
            background: #444;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .probability-rate {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .upgrade-section {
            background: #333;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }
        
        .upgrade-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
            padding: 6px;
            background: #444;
            border-radius: 4px;
        }
        
        .upgrade-icon {
            font-size: 16px;
            margin-right: 8px;
            width: 24px;
            text-align: center;
        }
        
        #bossWarning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 180;
            text-align: center;
            font-size: 48px;
            color: #ff0000;
            text-shadow: 2px 2px 4px #000;
            animation: bossWarning 2s ease-in-out;
            display: none;
        }
        
        @keyframes bossWarning {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
        }
        
        h2 {
            text-align: center;
            margin: 0 0 12px 0;
            color: #4CAF50;
            font-size: 16px;
        }
        
        h3 {
            margin: 10px 0 6px 0;
            color: #FFD700;
            font-size: 13px;
        }
        
        .game-tips {
            margin-top: 12px;
            padding: 10px;
            background: #444;
            border-radius: 6px;
            font-size: 14px;
            color: #ccc;
            text-align: center;
        }
        
        .game-tips p {
            margin: 3px 0;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1200px) {
            .difficulty-panel {
                flex-direction: column;
                max-height: 90vh;
            }
            
            .settings-left, .settings-right {
                flex: none;
                min-width: auto;
                max-height: none;
            }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .settings-left::-webkit-scrollbar,
        .settings-right::-webkit-scrollbar {
            width: 6px;
        }
        
        .settings-left::-webkit-scrollbar-track,
        .settings-right::-webkit-scrollbar-track {
            background: #333;
            border-radius: 3px;
        }
        
        .settings-left::-webkit-scrollbar-thumb,
        .settings-right::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 3px;
        }
        
        .settings-left::-webkit-scrollbar-thumb:hover,
        .settings-right::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- éš¾åº¦é€‰æ‹©ç•Œé¢ -->
        <div id="difficultySelect">
            <div class="difficulty-panel">
                <!-- å·¦ä¾§ï¼šæ¸¸æˆè®¾ç½® -->
                <div class="settings-left">
                    <h2>ğŸ® æ¸¸æˆè®¾ç½®</h2>
                    
                    <h3>é€‰æ‹©éš¾åº¦ï¼š</h3>
                    <div class="difficulty-buttons">
                        <button class="difficulty-btn" onclick="selectDifficulty('kindergarten')">ğŸ¼ å¹¼å„¿å›­</button>
                        <button class="difficulty-btn" onclick="selectDifficulty('elementary')">ğŸ“š å°å­¦ç”Ÿ</button>
                        <button class="difficulty-btn" onclick="selectDifficulty('middle')">â­ åˆä¸­ç”Ÿ</button>
                        <button class="difficulty-btn" onclick="selectDifficulty('high')">ğŸ”¥ é«˜ä¸­ç”Ÿ</button>
                        <button class="difficulty-btn" onclick="selectDifficulty('college')">ğŸ’€ å¤§å­¦ç”Ÿ</button>
                    </div>
                    
                    <div class="options-section">
                        <h3>å°„å‡»æ¨¡å¼ï¼š</h3>
                        <div class="shoot-mode-buttons">
                            <button id="autoShootBtn" class="shoot-mode-btn active" onclick="setShootMode(true)">ğŸ¯ è‡ªåŠ¨å°„å‡»</button>
                            <button id="manualShootBtn" class="shoot-mode-btn" onclick="setShootMode(false)">ğŸ–±ï¸ æ‰‹åŠ¨å°„å‡»</button>
                        </div>
                    </div>
                    
                    <div class="probability-section">
                        <h3>ğŸ“¦ é“å…·æ‰è½æ¦‚ç‡ï¼š</h3>
                        <div class="probability-item">
                            <span>ğŸ¼ å¹¼å„¿å›­</span>
                            <span class="probability-rate">12%</span>
                        </div>
                        <div class="probability-item">
                            <span>ğŸ“š å°å­¦ç”Ÿ</span>
                            <span class="probability-rate">10%</span>
                        </div>
                        <div class="probability-item">
                            <span>â­ åˆä¸­ç”Ÿ</span>
                            <span class="probability-rate">8%</span>
                        </div>
                        <div class="probability-item">
                            <span>ğŸ”¥ é«˜ä¸­ç”Ÿ</span>
                            <span class="probability-rate">6%</span>
                        </div>
                        <div class="probability-item">
                            <span>ğŸ’€ å¤§å­¦ç”Ÿ</span>
                            <span class="probability-rate">4%</span>
                        </div>
                    </div>
                    
                    <div class="game-tips">
                        <p>ğŸ’¡ <strong>æ¸¸æˆæç¤ºï¼š</strong></p>
                        <p>â€¢ é“å…·æ‰è½åœ¨åœ°ä¸Šï¼Œèµ°è¿‡å»æ‹¾å–</p>
                        <p>â€¢ æ¯10æ³¢ä¼šå‡ºç°è¶…çº§å¤§Boss</p>
                        <p>â€¢ å‡çº§éœ€è¦5ä¸ªæŠ€èƒ½ç‚¹</p>
                        <p>â€¢ ä½¿ç”¨WASDç§»åŠ¨ï¼Œé¼ æ ‡ç„å‡†å°„å‡»</p>
                    </div>
                </div>
                
                <!-- å³ä¾§ï¼šé“å…·è¯´æ˜å’Œå‡çº§é¢æ¿è¯´æ˜ -->
                <div class="settings-right">
                    <h2>ğŸ é“å…·è¯´æ˜</h2>
                    
                    <div class="powerup-guide">
                        <div class="powerup-item">
                            <div class="powerup-emoji">ğŸ’£</div>
                            <div>
                                <strong>ç‚¸å¼¹</strong><br>
                                <small>æŒ‰Qé”®ä½¿ç”¨ï¼Œé€ æˆ200ç‚¹èŒƒå›´çˆ†ç‚¸ä¼¤å®³</small>
                            </div>
                        </div>
                        <div class="powerup-item">
                            <div class="powerup-emoji">â­</div>
                            <div>
                                <strong>æ— æ•ŒæŠ¤ç›¾</strong><br>
                                <small>æ‹¾å–åç«‹å³ç”Ÿæ•ˆï¼Œ3ç§’å®Œå…¨å…ç–«ä¼¤å®³</small>
                            </div>
                            <div class="powerup-preview invulnerable-preview">âœ¨</div>
                        </div>
                        <div class="powerup-item">
                            <div class="powerup-emoji">â°</div>
                            <div>
                                <strong>æ—¶é—´å‡é€Ÿ</strong><br>
                                <small>æ‰€æœ‰æ•Œäººé€Ÿåº¦é™è‡³30%ï¼ŒæŒç»­5ç§’</small>
                            </div>
                            <div class="powerup-preview time-slow-preview">ğŸ•</div>
                        </div>
                        <div class="powerup-item">
                            <div class="powerup-emoji">ğŸ”¥</div>
                            <div>
                                <strong>åŒå€å°„é€Ÿ</strong><br>
                                <small>å°„å‡»é—´éš”å‡åŠï¼ŒæŒç»­10ç§’</small>
                            </div>
                            <div class="powerup-preview double-fire-preview">ğŸ”¥</div>
                        </div>
                        <div class="powerup-item">
                            <div class="powerup-emoji">ğŸ”«</div>
                            <div>
                                <strong>ç©¿é€å¼¹</strong><br>
                                <small>å­å¼¹å¯ç©¿é€å¤šä¸ªæ•Œäººï¼ŒæŒç»­7.5ç§’</small>
                            </div>
                            <div class="powerup-preview piercing-preview">âš¡</div>
                        </div>
                        <div class="powerup-item">
                            <div class="powerup-emoji">ğŸ’š</div>
                            <div>
                                <strong>æ²»ç–—å…‰ç¯</strong><br>
                                <small>æ¯ç§’å›å¤2ç‚¹è¡€é‡ï¼ŒæŒç»­10ç§’</small>
                            </div>
                            <div class="powerup-preview regen-preview">â¤ï¸</div>
                        </div>
                    </div>
                    
                    <div class="upgrade-section">
                        <h3>âš¡ å‡çº§ç³»ç»Ÿè¯´æ˜ï¼š</h3>
                        <div class="upgrade-item">
                            <div class="upgrade-icon">âš”ï¸</div>
                            <div>
                                <strong>æ”»å‡»åŠ›</strong><br>
                                <small>æ¯çº§å¢åŠ 5ç‚¹ä¼¤å®³ï¼Œæœ€å¤šå‡çº§10æ¬¡</small>
                            </div>
                        </div>
                        <div class="upgrade-item">
                            <div class="upgrade-icon">â¤ï¸</div>
                            <div>
                                <strong>ç”Ÿå‘½å€¼</strong><br>
                                <small>æ¯çº§å¢åŠ 20ç‚¹æœ€å¤§ç”Ÿå‘½å€¼ï¼Œæœ€å¤šå‡çº§10æ¬¡</small>
                            </div>
                        </div>
                        <div class="upgrade-item">
                            <div class="upgrade-icon">ğŸ¯</div>
                            <div>
                                <strong>å°„é€Ÿ</strong><br>
                                <small>æ¯çº§å‡å°‘20æ¯«ç§’å°„å‡»é—´éš”ï¼Œæœ€å¤šå‡çº§10æ¬¡</small>
                            </div>
                        </div>
                        <div class="upgrade-item">
                            <div class="upgrade-icon">ğŸ’¨</div>
                            <div>
                                <strong>ç§»åŠ¨é€Ÿåº¦</strong><br>
                                <small>æ¯çº§å¢åŠ 0.5ç§»åŠ¨é€Ÿåº¦ï¼Œæœ€å¤šå‡çº§10æ¬¡</small>
                            </div>
                        </div>
                        <div class="upgrade-item">
                            <div class="upgrade-icon">ğŸ“¦</div>
                            <div>
                                <strong>å¼¹è¯å®¹é‡</strong><br>
                                <small>æ¯çº§å¢åŠ 10å‘å¼¹è¯ï¼Œæœ€å¤šå‡çº§10æ¬¡</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <canvas id="gameCanvas" width="1000" height="700"></canvas>
        
        <button id="upgradeToggle" onclick="toggleUpgradePanel()">å‡çº§é¢æ¿</button>
        
        <div id="pauseOverlay">
            <div>æ¸¸æˆå·²æš‚åœ - å‡çº§å±æ€§ä¸­</div>
        </div>
        
        <div id="bossWarning">
            <div>âš¡ è¶…çº§å¤§Bossæ¥è¢­! âš¡</div>
        </div>
        
        <div id="ui">
            <div><strong>ç­‰çº§:</strong> <span id="level">1</span></div>
            <div><strong>åˆ†æ•°:</strong> <span id="score">0</span></div>
            <div><strong>å‡»æ€:</strong> <span id="kills">0</span></div>
            <div><strong>æ³¢æ•°:</strong> <span id="wave">1</span></div>
            <div><strong>éš¾åº¦:</strong> <span id="currentDifficulty">åˆä¸­ç”Ÿ</span></div>
            
            <div style="margin-top: 10px;">
                <div>ç”Ÿå‘½å€¼</div>
                <div class="stat-bar">
                    <div id="healthBar" class="health-fill" style="width: 100%; height: 100%;"></div>
                </div>
                <span id="healthText">100/100</span>
            </div>
            
            <div>
                <div>ç»éªŒå€¼</div>
                <div class="stat-bar">
                    <div id="expBar" class="exp-fill" style="width: 0%; height: 100%;"></div>
                </div>
                <span id="expText">0/100</span>
            </div>
            
            <div>
                <div>å¼¹è¯ <span id="reloadStatus"></span></div>
                <div class="stat-bar">
                    <div id="ammoBar" class="ammo-fill" style="width: 100%; height: 100%;"></div>
                </div>
                <span id="ammoText">30/30</span>
            </div>
            
            <div style="margin-top: 10px; font-size: 10px;">
                <div><strong>é“å…·:</strong></div>
                <div>ğŸ’£ ç‚¸å¼¹: <span id="bombCount">0</span> (æŒ‰Q)</div>
                <div id="shootMode">ğŸ¯ å°„å‡»: è‡ªåŠ¨æ¨¡å¼</div>
            </div>
        </div>
        
        <div id="rightPanel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <strong>å±æ€§å‡çº§</strong>
                <button onclick="toggleUpgradePanel()" style="background: #666; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; z-index: 160;">å…³é—­</button>
            </div>
            
            <div style="margin-top: 10px;">
                <div>æ”»å‡»åŠ›: <span id="damageLevel">1</span>/10</div>
                <button class="upgrade-btn" onclick="upgradeAttribute('damage')">å‡çº§ (5ç‚¹)</button>
            </div>
            
            <div>
                <div>ç”Ÿå‘½å€¼: <span id="healthLevel">1</span>/10</div>
                <button class="upgrade-btn" onclick="upgradeAttribute('health')">å‡çº§ (5ç‚¹)</button>
            </div>
            
            <div>
                <div>å°„é€Ÿ: <span id="fireRateLevel">1</span>/10</div>
                <button class="upgrade-btn" onclick="upgradeAttribute('fireRate')">å‡çº§ (5ç‚¹)</button>
            </div>
            
            <div>
                <div>ç§»åŠ¨é€Ÿåº¦: <span id="speedLevel">1</span>/10</div>
                <button class="upgrade-btn" onclick="upgradeAttribute('speed')">å‡çº§ (5ç‚¹)</button>
            </div>
            
            <div>
                <div>å¼¹è¯å®¹é‡: <span id="ammoLevel">1</span>/10</div>
                <button class="upgrade-btn" onclick="upgradeAttribute('ammo')">å‡çº§ (5ç‚¹)</button>
            </div>
            
            <div style="margin-top: 15px;">
                <div><strong>å¯ç”¨ç‚¹æ•°:</strong> <span id="skillPoints">0</span></div>
            </div>
            
            <div style="margin-top: 15px;">
                <div><strong>æ­¦å™¨ç±»å‹:</strong></div>
                <div id="weaponType">æ ‡å‡†å°„å‡»</div>
            </div>
        </div>
        
        <div id="instructions">
            <div><strong>æ“ä½œè¯´æ˜:</strong></div>
            <div>WASD - ç§»åŠ¨</div>
            <div>é¼ æ ‡ - ç„å‡†å°„å‡»</div>
            <div>R - ä¸»åŠ¨è£…å¼¹</div>
            <div>Q - ä½¿ç”¨ç‚¸å¼¹</div>
            <div>T - åˆ‡æ¢å°„å‡»æ¨¡å¼</div>
            <div>1-3 - åˆ‡æ¢æ­¦å™¨</div>
            <div>å³ä¸Šè§’ - å‡çº§é¢æ¿</div>
        </div>
        
        <div id="gameOver">
            <h2>æ¸¸æˆç»“æŸ!</h2>
            <div>æœ€ç»ˆç­‰çº§: <span id="finalLevel">1</span></div>
            <div>æœ€ç»ˆåˆ†æ•°: <span id="finalScore">0</span></div>
            <div>æ€»å‡»æ€æ•°: <span id="finalKills">0</span></div>
            <div>å­˜æ´»æ³¢æ•°: <span id="finalWave">1</span></div>
            <div>æ¸¸æˆéš¾åº¦: <span id="finalDifficulty">åˆä¸­ç”Ÿ</span></div>
            <button class="restart-btn" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ ¸å¿ƒå˜é‡
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // å›¾ç‰‡èµ„æº
        let gameImages = {
            spriteSheet: null,
            loaded: false
        };

        // ç²¾çµå›¾åæ ‡å®šä¹‰ (æ ¹æ®æ‚¨é€‰æ‹©çš„å®é™…åæ ‡)
        const spriteCoords = {
            player: { x: 684, y: 530, width: 262, height: 248 },
            boss: { x: 685, y: 62, width: 265, height: 236 },
            megaBoss: { x: 47, y: 28, width: 336, height: 321 },
            basicEnemy: { x: 386, y: 329, width: 244, height: 219 },
            fastEnemy: { x: 739, y: 346, width: 149, height: 150 },
            tankEnemy: { x: 680, y: 786, width: 268, height: 225 }
        };

        // åŠ è½½å›¾ç‰‡èµ„æº
        function loadGameImages() {
            const img = new Image();
            img.onload = function() {
                gameImages.spriteSheet = img;
                gameImages.loaded = true;
                console.log('æ¸¸æˆå›¾ç‰‡èµ„æºåŠ è½½å®Œæˆï¼Œå°ºå¯¸:', img.width, 'x', img.height);
            };
            img.onerror = function() {
                console.error('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤ç»˜åˆ¶æ–¹å¼');
                gameImages.loaded = false;
            };
            console.log('å¼€å§‹åŠ è½½å›¾ç‰‡:', '../assets/images/InfiniteShooting/2dgamepic.png');
            img.src = '../assets/images/InfiniteShooting/2dgamepic.png';
        }

        // ç»˜åˆ¶ç²¾çµå›¾ç‰‡
        function drawSprite(spriteKey, x, y, angle = 0, scale = 1) {
            if (!gameImages.loaded || !gameImages.spriteSheet) {
                return false; // è¿”å›falseè¡¨ç¤ºéœ€è¦ä½¿ç”¨é»˜è®¤ç»˜åˆ¶æ–¹å¼
            }

            const sprite = spriteCoords[spriteKey];
            if (!sprite) return false;

            ctx.save();
            ctx.translate(x, y);
            if (angle !== 0) {
                ctx.rotate(angle);
            }

            const drawWidth = sprite.width * scale;
            const drawHeight = sprite.height * scale;

            ctx.drawImage(
                gameImages.spriteSheet,
                sprite.x, sprite.y, sprite.width, sprite.height,
                -drawWidth/2, -drawHeight/2, drawWidth, drawHeight
            );

            ctx.restore();
            return true; // æˆåŠŸç»˜åˆ¶
        }

        // æ¸¸æˆé€‰é¡¹
        let autoShoot = true;
        
        // éš¾åº¦é…ç½®
        const difficultySettings = {
            kindergarten: {
                name: 'å¹¼å„¿å›­',
                enemyDamageMultiplier: 0.25,
                enemyHealthMultiplier: 0.4,
                enemySpeedMultiplier: 0.6,
                playerHealthMultiplier: 2.5,
                expMultiplier: 2.0,
                dashDamageMultiplier: 1.1,
                powerUpDropRate: 0.12
            },
            elementary: {
                name: 'å°å­¦ç”Ÿ',
                enemyDamageMultiplier: 0.5,
                enemyHealthMultiplier: 0.7,
                enemySpeedMultiplier: 0.8,
                playerHealthMultiplier: 1.8,
                expMultiplier: 1.5,
                dashDamageMultiplier: 1.2,
                powerUpDropRate: 0.1
            },
            middle: {
                name: 'åˆä¸­ç”Ÿ',
                enemyDamageMultiplier: 1.0,
                enemyHealthMultiplier: 1.0,
                enemySpeedMultiplier: 1.0,
                playerHealthMultiplier: 1.0,
                expMultiplier: 1.0,
                dashDamageMultiplier: 1.5,
                powerUpDropRate: 0.08
            },
            high: {
                name: 'é«˜ä¸­ç”Ÿ',
                enemyDamageMultiplier: 1.4,
                enemyHealthMultiplier: 1.3,
                enemySpeedMultiplier: 1.2,
                playerHealthMultiplier: 0.7,
                expMultiplier: 1.3,
                dashDamageMultiplier: 1.8,
                powerUpDropRate: 0.06
            },
            college: {
                name: 'å¤§å­¦ç”Ÿ',
                enemyDamageMultiplier: 1.8,
                enemyHealthMultiplier: 1.6,
                enemySpeedMultiplier: 1.4,
                playerHealthMultiplier: 0.5,
                expMultiplier: 1.5,
                dashDamageMultiplier: 2.2,
                powerUpDropRate: 0.04
            }
        };
        
        let currentDifficulty = 'middle';
        
        // æ¸¸æˆçŠ¶æ€
        let gameRunning = false;
        let gamePaused = false;
        let gameTime = 0;
        let upgradeVisible = false;
        
        // ç©å®¶å¯¹è±¡
        let player = {
            x: 500,
            y: 350,
            size: 15,
            health: 100,
            maxHealth: 100,
            speed: 3,
            angle: 0,
            exp: 0,
            level: 1,
            skillPoints: 0,
            ammo: 30,
            maxAmmo: 30,
            reloading: false,
            reloadTime: 0,
            autoReloading: false,
            lastShot: 0,
            fireRate: 200,
            damage: 20,
            weaponType: 0,
            bombCount: 0,
            slowedUntil: 0,
            speedMultiplier: 1.0,
            attributes: {
                damage: 1,
                health: 1,
                fireRate: 1,
                speed: 1,
                ammo: 1
            },
            powerUps: {
                invulnerable: 0,
                timeSlow: 0,
                doubleFire: 0,
                piercing: 0,
                regen: 0
            }
        };
        
        // æ¸¸æˆæ•°æ®
        let enemies = [];
        let enemyBullets = [];
        let bullets = [];
        let items = [];
        let particles = [];
        let explosions = [];
        let shockwaves = [];
        let score = 0;
        let kills = 0;
        let wave = 1;
        let waveProgress = 0;
        let enemiesInWave = 10;
        
        // æ§åˆ¶
        let keys = {};
        let mouseX = 0;
        let mouseY = 0;
        let mouseDown = false;
        
        // æ•Œäººç±»å‹
        const enemyTypes = {
            basic: { 
                color: '#ff4444', 
                size: 12, 
                health: 40, 
                speed: 1, 
                damage: 15, 
                exp: 10, 
                score: 10 
            },
            fast: { 
                color: '#44ff44', 
                size: 8, 
                health: 20, 
                speed: 2.5, 
                damage: 10, 
                exp: 15, 
                score: 15 
            },
            tank: { 
                color: '#4444ff', 
                size: 18, 
                health: 100, 
                speed: 0.5, 
                damage: 30, 
                exp: 30, 
                score: 30 
            },
            shooter: { 
                color: '#ff44ff', 
                size: 10, 
                health: 30, 
                speed: 1.2, 
                damage: 12, 
                exp: 20, 
                score: 20,
                canShoot: true 
            },
            boss: {
                color: '#ff0000',
                size: 30,
                health: 300,
                speed: 0.8,
                damage: 40,
                exp: 100,
                score: 100,
                canShoot: true,
                canDash: true,
                isBoss: true
            },
            megaBoss: {
                color: '#ff0000',
                size: 50,
                health: 1000,
                speed: 0.6,
                damage: 60,
                exp: 500,
                score: 1000,
                canShoot: true,
                canDash: true,
                canShockwave: true,
                isBoss: true,
                isMegaBoss: true,
                specialAbilities: ['summon', 'teleport', 'laser', 'split']
            }
        };
        
        // æ­¦å™¨ç±»å‹
        const weapons = [
            { name: 'æ ‡å‡†å°„å‡»', color: '#ffff00', speed: 8, size: 3 },
            { name: 'æ•£å¼¹æª', color: '#ff8800', speed: 6, size: 2 },
            { name: 'æ¿€å…‰æª', color: '#00ffff', speed: 12, size: 4 }
        ];
        
        // é“å…·ç±»å‹
        const powerUpTypes = {
            bomb: { 
                name: 'ç‚¸å¼¹', 
                emoji: 'ğŸ’£',
                color: '#ff6600', 
                effect: 'bomb',
                description: 'èŒƒå›´çˆ†ç‚¸ä¼¤å®³'
            },
            invulnerable: { 
                name: 'æ— æ•Œ', 
                emoji: 'â­',
                color: '#gold', 
                effect: 'invulnerable',
                duration: 180, // 3ç§’
                description: 'çŸ­æ—¶é—´æ— æ•Œ'
            },
            timeSlow: { 
                name: 'æ—¶é—´å‡é€Ÿ', 
                emoji: 'â°',
                color: '#cyan', 
                effect: 'timeSlow',
                duration: 300, // 5ç§’
                description: 'æ•Œäººè¡ŒåŠ¨å˜æ…¢'
            },
            doubleFire: { 
                name: 'åŒå€å°„é€Ÿ', 
                emoji: 'ğŸ”¥',
                color: '#orange', 
                effect: 'doubleFire',
                duration: 600, // 10ç§’
                description: 'å°„é€Ÿç¿»å€'
            },
            piercing: { 
                name: 'ç©¿é€å¼¹', 
                emoji: 'ğŸ”«',
                color: '#9d4edd', 
                effect: 'piercing',
                duration: 450, // 7.5ç§’
                description: 'å­å¼¹ç©¿é€æ•Œäºº'
            },
            regen: { 
                name: 'æ²»ç–—å…‰ç¯', 
                emoji: 'ğŸ’š',
                color: '#green', 
                effect: 'regen',
                duration: 600, // 10ç§’
                description: 'æŒç»­å›è¡€'
            }
        };
        
        // å°„å‡»æ¨¡å¼è®¾ç½®
        function setShootMode(isAuto) {
            autoShoot = isAuto;
            
            const autoBtn = document.getElementById('autoShootBtn');
            const manualBtn = document.getElementById('manualShootBtn');
            
            if (isAuto) {
                autoBtn.classList.add('active');
                autoBtn.disabled = true;
                manualBtn.classList.remove('active');
                manualBtn.disabled = false;
            } else {
                manualBtn.classList.add('active');
                manualBtn.disabled = true;
                autoBtn.classList.remove('active');
                autoBtn.disabled = false;
            }
            
            updateUI();
        }
        
        // éš¾åº¦é€‰æ‹©
        function selectDifficulty(difficulty) {
            currentDifficulty = difficulty;
            document.getElementById('difficultySelect').style.display = 'none';
            
            // æ ¹æ®éš¾åº¦è°ƒæ•´ç©å®¶åˆå§‹å±æ€§
            const settings = difficultySettings[difficulty];
            player.maxHealth = Math.floor(100 * settings.playerHealthMultiplier);
            player.health = player.maxHealth;
            
            gameRunning = true;
            updateUI();
        }
        
        // å‡çº§é¢æ¿æ§åˆ¶
        function toggleUpgradePanel() {
            upgradeVisible = !upgradeVisible;
            gamePaused = upgradeVisible;
            
            document.getElementById('rightPanel').style.display = upgradeVisible ? 'block' : 'none';
            document.getElementById('pauseOverlay').style.display = upgradeVisible ? 'flex' : 'none';
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function init() {
            loadGameImages(); // åŠ è½½å›¾ç‰‡èµ„æº
            setupEventListeners();
            gameLoop();
            setInterval(spawnEnemies, 3000);
        }
        
        // äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            document.addEventListener('keydown', (e) => {
                keys[e.code] = true;
                
                if (e.code === 'KeyR') {
                    reload();
                }
                
                if (e.code === 'KeyQ') {
                    useBomb();
                }
                
                if (e.code === 'KeyT') {
                    setShootMode(!autoShoot);
                }
                
                if (e.code === 'Digit1') player.weaponType = 0;
                if (e.code === 'Digit2') player.weaponType = 1;
                if (e.code === 'Digit3') player.weaponType = 2;
            });
            
            document.addEventListener('keyup', (e) => {
                keys[e.code] = false;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                mouseX = e.clientX - rect.left;
                mouseY = e.clientY - rect.top;
            });
            
            canvas.addEventListener('mousedown', (e) => {
                mouseDown = true;
            });
            
            canvas.addEventListener('mouseup', (e) => {
                mouseDown = false;
            });
        }
        
        // ç”Ÿæˆæ•Œäºº
        function spawnEnemies() {
            if (!gameRunning || gamePaused) return;
            
            // æ¯10æ³¢ç”Ÿæˆå¤§Boss
            if (wave % 10 === 0 && waveProgress === 0) {
                showBossWarning();
                setTimeout(() => {
                    spawnEnemy('megaBoss');
                }, 2000);
                waveProgress++;
                return;
            }
            
            const types = Object.keys(enemyTypes);
            const spawnCount = Math.min(5 + Math.floor(wave / 2), 10);
            
            // æ™®é€šBossç”Ÿæˆ
            const bossCount = Math.min(1 + Math.floor(wave / 3), 2);
            
            for (let i = 0; i < spawnCount; i++) {
                const availableTypes = types.filter(t => t !== 'boss' && t !== 'megaBoss');
                const type = availableTypes[Math.floor(Math.random() * availableTypes.length)];
                spawnEnemy(type);
            }
            
            // ç”Ÿæˆæ™®é€šBoss (é10æ³¢å€æ•°æ—¶)
            if (wave % 10 !== 0) {
                for (let i = 0; i < bossCount; i++) {
                    spawnEnemy('boss');
                }
            }
            
            waveProgress++;
            if (waveProgress >= 5) {
                wave++;
                waveProgress = 0;
                enemiesInWave += 2;
            }
        }
        
        function showBossWarning() {
            const warning = document.getElementById('bossWarning');
            warning.style.display = 'block';
            setTimeout(() => {
                warning.style.display = 'none';
            }, 2000);
        }
        
        function spawnEnemy(type) {
            const enemyTemplate = enemyTypes[type];
            const settings = difficultySettings[currentDifficulty];
            
            let x, y;
            if (Math.random() < 0.5) {
                x = Math.random() < 0.5 ? -50 : canvas.width + 50;
                y = Math.random() * canvas.height;
            } else {
                x = Math.random() * canvas.width;
                y = Math.random() < 0.5 ? -50 : canvas.height + 50;
            }
            
            // å¤§Bossè¡€é‡é€’å¢
            let healthMultiplier = 1 + wave * 0.2;
            if (type === 'megaBoss') {
                healthMultiplier = 1.5 + (Math.floor(wave / 10)) * 0.8; // æ¯10æ³¢å¤§å¹…å¢å¼º
            }
            
            const enemy = {
                x: x,
                y: y,
                type: type,
                ...enemyTemplate,
                health: enemyTemplate.health * healthMultiplier * settings.enemyHealthMultiplier,
                maxHealth: enemyTemplate.health * healthMultiplier * settings.enemyHealthMultiplier,
                damage: enemyTemplate.damage * settings.enemyDamageMultiplier,
                speed: enemyTemplate.speed * settings.enemySpeedMultiplier,
                lastShot: 0,
                lastDash: 0,
                lastSpecial: 0,
                dashCooldown: 3000,
                isDashing: false,
                dashTime: 0,
                lastHitTime: 0,
                isInvulnerable: false,
                invulnerableUntil: 0,
                slowedUntil: 0,
                speedMultiplier: 1.0
            };
            
            enemies.push(enemy);
        }
        
        // ä½¿ç”¨ç‚¸å¼¹
        function useBomb() {
            if (player.bombCount <= 0) return;
            
            player.bombCount--;
            createExplosion(player.x, player.y, 100, 200);
            updateUI();
        }
        
        // åˆ›å»ºçˆ†ç‚¸
        function createExplosion(x, y, radius, damage) {
            explosions.push({
                x: x,
                y: y,
                radius: 0,
                maxRadius: radius,
                damage: damage,
                life: 30
            });
            
            createParticles(x, y, '#ff6600', 20);
        }
        
        // å°„å‡»
        function shoot() {
            const now = Date.now();
            let fireRate = player.fireRate;
            
            // åŒå€å°„é€Ÿæ•ˆæœ
            if (player.powerUps.doubleFire > 0) {
                fireRate /= 2;
            }
            
            if (now - player.lastShot < fireRate || player.reloading) {
                return;
            }
            
            // è‡ªåŠ¨æ¢å¼¹
            if (player.ammo <= 0) {
                if (!player.autoReloading) {
                    player.autoReloading = true;
                    reload();
                }
                return;
            }
            
            player.lastShot = now;
            
            const weapon = weapons[player.weaponType];
            
            if (player.weaponType === 1) { // æ•£å¼¹æª
                for (let i = 0; i < 5; i++) {
                    const angle = player.angle + (Math.random() - 0.5) * 0.5;
                    createBullet(angle, weapon);
                }
                player.ammo -= 3;
            } else {
                createBullet(player.angle, weapon);
                player.ammo--;
            }
        }
        
        function createBullet(angle, weapon) {
            const bullet = {
                x: player.x,
                y: player.y,
                angle: angle,
                vx: Math.cos(angle) * weapon.speed,
                vy: Math.sin(angle) * weapon.speed,
                speed: weapon.speed,
                size: weapon.size,
                color: weapon.color,
                damage: player.damage * player.attributes.damage,
                life: 100,
                piercing: player.powerUps.piercing > 0
            };
            bullets.push(bullet);
        }
        
        // æ•Œäººå°„å‡»
        function enemyShoot(enemy) {
            const angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
            const bullet = {
                x: enemy.x,
                y: enemy.y,
                angle: angle,
                vx: Math.cos(angle) * 4,
                vy: Math.sin(angle) * 4,
                speed: 4,
                size: 4,
                color: '#ff0000',
                damage: enemy.damage * 0.5,
                life: 150
            };
            enemyBullets.push(bullet);
        }
        
        // å¤§Bosså†²å‡»æ³¢
        function bossShockwave(boss) {
            shockwaves.push({
                x: boss.x,
                y: boss.y,
                radius: 0,
                maxRadius: 200,
                damage: boss.damage * 0.7,
                slowDuration: wave * 30,
                life: 60,
                color: '#ff00ff'
            });
        }
        
        // å¤§Bossç‰¹æ®ŠæŠ€èƒ½
        function useBossSpecial(boss) {
            if (!boss.specialAbilities || Date.now() - boss.lastSpecial < 5000) return;
            
            const ability = boss.specialAbilities[Math.floor(Math.random() * boss.specialAbilities.length)];
            boss.lastSpecial = Date.now();
            
            switch(ability) {
                case 'summon':
                    // å¬å”¤å°æ€ª
                    for (let i = 0; i < 3; i++) {
                        spawnEnemy('basic');
                    }
                    break;
                    
                case 'teleport':
                    // ç¬ç§»åˆ°ç©å®¶é™„è¿‘
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 150;
                    boss.x = player.x + Math.cos(angle) * distance;
                    boss.y = player.y + Math.sin(angle) * distance;
                    boss.x = Math.max(boss.size, Math.min(canvas.width - boss.size, boss.x));
                    boss.y = Math.max(boss.size, Math.min(canvas.height - boss.size, boss.y));
                    createParticles(boss.x, boss.y, '#purple', 15);
                    break;
                    
                case 'laser':
                    // æ¿€å…‰æ‰«å°„
                    for (let i = 0; i < 8; i++) {
                        const laserAngle = (Math.PI * 2 / 8) * i;
                        const bullet = {
                            x: boss.x,
                            y: boss.y,
                            angle: laserAngle,
                            vx: Math.cos(laserAngle) * 6,
                            vy: Math.sin(laserAngle) * 6,
                            speed: 6,
                            size: 6,
                            color: '#00ffff',
                            damage: boss.damage * 0.8,
                            life: 120
                        };
                        enemyBullets.push(bullet);
                    }
                    break;
                    
                case 'split':
                    // åˆ†èº«æ”»å‡»
                    if (boss.health < boss.maxHealth * 0.3) {
                        for (let i = 0; i < 2; i++) {
                            spawnEnemy('shooter');
                        }
                    }
                    break;
            }
        }
        
        // è£…å¼¹
        function reload() {
            if (!player.reloading && player.ammo < player.maxAmmo) {
                player.reloading = true;
                player.reloadTime = 60; // 60å¸§ = 1ç§’
            }
        }
        
        // æ‰è½ç‰©å“
        function dropItem(x, y, isBoss = false) {
            const settings = difficultySettings[currentDifficulty];
            const dropRate = isBoss ? 0.6 : settings.powerUpDropRate;
            
            if (Math.random() < dropRate) {
                const powerUpKeys = Object.keys(powerUpTypes);
                const type = powerUpKeys[Math.floor(Math.random() * powerUpKeys.length)];
                
                items.push({
                    x: x,
                    y: y,
                    type: type,
                    life: 900, // 15ç§’æœ‰æ•ˆæœŸ
                    size: 15,
                    isPowerUp: true,
                    blinkTimer: 0
                });
            }
            
            // æ™®é€šæ‰è½ç‰©
            if (Math.random() < 0.25) {
                const basicTypes = ['health', 'ammo', 'exp'];
                const type = basicTypes[Math.floor(Math.random() * basicTypes.length)];
                
                items.push({
                    x: x,
                    y: y,
                    type: type,
                    life: 300,
                    size: 8,
                    isPowerUp: false,
                    blinkTimer: 0
                });
            }
        }
        
        // ä½¿ç”¨é“å…·
        function usePowerUp(type) {
            const powerUp = powerUpTypes[type];
            
            switch(powerUp.effect) {
                case 'bomb':
                    player.bombCount++;
                    break;
                    
                case 'invulnerable':
                    player.powerUps.invulnerable = powerUp.duration;
                    break;
                    
                case 'timeSlow':
                    player.powerUps.timeSlow = powerUp.duration;
                    break;
                    
                case 'doubleFire':
                    player.powerUps.doubleFire = powerUp.duration;
                    break;
                    
                case 'piercing':
                    player.powerUps.piercing = powerUp.duration;
                    break;
                    
                case 'regen':
                    player.powerUps.regen = powerUp.duration;
                    break;
            }
        }
        
        // å‡çº§å±æ€§
        function upgradeAttribute(attr) {
            if (player.skillPoints < 5 || player.attributes[attr] >= 10) return;
            
            player.skillPoints -= 5;
            player.attributes[attr]++;
            
            switch(attr) {
                case 'damage':
                    player.damage += 5;
                    break;
                case 'health':
                    player.maxHealth += 20;
                    player.health = Math.min(player.health + 20, player.maxHealth);
                    break;
                case 'fireRate':
                    player.fireRate = Math.max(50, player.fireRate - 20);
                    break;
                case 'speed':
                    player.speed += 0.5;
                    break;
                case 'ammo':
                    player.maxAmmo += 10;
                    player.ammo += 10;
                    break;
            }
            
            updateUI();
        }
        
        // è·å¾—ç»éªŒå€¼
        function gainExp(amount) {
            const settings = difficultySettings[currentDifficulty];
            const adjustedExp = Math.floor(amount * settings.expMultiplier);
            player.exp += adjustedExp;
            
            const expNeeded = player.level * 100;
            if (player.exp >= expNeeded) {
                player.exp -= expNeeded;
                player.level++;
                player.skillPoints += 5;
                
                player.health = Math.min(player.health + 20, player.maxHealth);
                createParticles(player.x, player.y, '#ffff00', 15);
            }
        }
        
        // åˆ›å»ºç²’å­æ•ˆæœ
        function createParticles(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    color: color,
                    life: 30,
                    size: Math.random() * 4 + 2
                });
            }
        }
        
        // æ¸²æŸ“ç©å®¶çŠ¶æ€ç‰¹æ•ˆ
        function renderPlayerEffects() {
            const currentTime = Date.now();
            
            // æ— æ•Œå…‰ç¯æ•ˆæœ - æ”¹ä¸ºé‡‘è‰²å…‰æ™•
            if (player.powerUps.invulnerable > 0) {
                const radius1 = 25 + Math.sin(currentTime * 0.01) * 5;
                const radius2 = 35 + Math.sin(currentTime * 0.015) * 3;
                const radius3 = 45 + Math.sin(currentTime * 0.008) * 4;
                
                // å†…åœˆé‡‘è‰²å…‰ç¯
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 4;
                ctx.globalAlpha = 0.9;
                ctx.shadowColor = '#FFD700';
                ctx.shadowBlur = 15;
                
                ctx.beginPath();
                ctx.arc(player.x, player.y, radius1, 0, Math.PI * 2);
                ctx.stroke();
                
                // ä¸­åœˆå…‰ç¯
                ctx.strokeStyle = '#FFA500';
                ctx.lineWidth = 3;
                ctx.globalAlpha = 0.7;
                ctx.shadowBlur = 10;
                
                ctx.beginPath();
                ctx.arc(player.x, player.y, radius2, 0, Math.PI * 2);
                ctx.stroke();
                
                // å¤–åœˆå…‰ç¯
                ctx.strokeStyle = '#FFFF00';
                ctx.lineWidth = 2;
                ctx.globalAlpha = 0.5;
                ctx.shadowBlur = 20;
                
                ctx.beginPath();
                ctx.arc(player.x, player.y, radius3, 0, Math.PI * 2);
                ctx.stroke();
                
                ctx.shadowBlur = 0;
                ctx.globalAlpha = 1;
            }
            
            // æ—¶é—´å‡é€Ÿç‰¹æ•ˆ
            if (player.powerUps.timeSlow > 0) {
                const radius = 30 + Math.sin(currentTime * 0.008) * 8;
                ctx.strokeStyle = '#cyan';
                ctx.lineWidth = 2;
                ctx.globalAlpha = 0.6;
                
                for (let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    ctx.arc(player.x, player.y, radius + i * 10, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                ctx.globalAlpha = 1;
            }
            
            // åŒå€å°„é€Ÿç«ç„°ç‰¹æ•ˆ
            if (player.powerUps.doubleFire > 0) {
                for (let i = 0; i < 6; i++) {
                    const angle = (Math.PI * 2 / 6) * i + currentTime * 0.01;
                    const fireX = player.x + Math.cos(angle) * 20;
                    const fireY = player.y + Math.sin(angle) * 20;
                    
                    ctx.fillStyle = i % 2 === 0 ? '#ff6600' : '#ff3300';
                    ctx.globalAlpha = 0.7;
                    ctx.beginPath();
                    ctx.arc(fireX, fireY, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.globalAlpha = 1;
            }
            
            // æ²»ç–—å…‰ç¯ç»¿è‰²è„‰å†²
            if (player.powerUps.regen > 0) {
                const radius = 22 + Math.sin(currentTime * 0.012) * 4;
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.globalAlpha = 0.5;
                
                ctx.beginPath();
                ctx.arc(player.x, player.y, radius, 0, Math.PI * 2);
                ctx.stroke();
                
                ctx.globalAlpha = 1;
            }
            
            // ç©¿é€å¼¹ç´«è‰²å…‰æ™•
            if (player.powerUps.piercing > 0) {
                const radius = 18 + Math.sin(currentTime * 0.02) * 3;
                ctx.strokeStyle = '#9d4edd';
                ctx.lineWidth = 2;
                ctx.globalAlpha = 0.6;
                
                ctx.beginPath();
                ctx.arc(player.x, player.y, radius, 0, Math.PI * 2);
                ctx.stroke();
                
                ctx.globalAlpha = 1;
            }
        }
        
        // æ¸²æŸ“Bossç‰¹æ•ˆ
        function renderBossEffects(enemy) {
            const currentTime = Date.now();
            
            if (enemy.isInvulnerable) {
                const radius = enemy.size + 15 + Math.sin(currentTime * 0.02) * 5;
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 4;
                ctx.globalAlpha = 0.8;
                
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, radius, 0, Math.PI * 2);
                ctx.stroke();
                
                ctx.globalAlpha = 1;
            }
        }
        
        // åœ¨ç©å®¶å¤´é¡¶æ˜¾ç¤ºçŠ¶æ€æ–‡å­—
        function renderPlayerStatusText() {
            const statusTexts = [];
            
            Object.entries(player.powerUps).forEach(([key, duration]) => {
                if (duration > 0) {
                    const seconds = Math.ceil(duration / 60);
                    const powerUp = powerUpTypes[key];
                    if (powerUp) {
                        statusTexts.push(`${powerUp.emoji} ${seconds}s`);
                    }
                }
            });
            
            if (player.slowedUntil > gameTime) {
                const seconds = Math.ceil((player.slowedUntil - gameTime) / 60);
                statusTexts.push(`ğŸŒ ${seconds}s`);
            }
            
            if (statusTexts.length > 0) {
                ctx.fillStyle = 'white';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                
                const text = statusTexts.join(' ');
                const textY = player.y - player.size - 25;
                
                ctx.strokeText(text, player.x, textY);
                ctx.fillText(text, player.x, textY);
            }
        }
        
        // æ›´æ–°æ¸¸æˆé€»è¾‘
        function update() {
            if (!gameRunning || gamePaused) return;
            
            gameTime++;
            
            // æ›´æ–°ç©å®¶buffçŠ¶æ€
            Object.keys(player.powerUps).forEach(key => {
                if (player.powerUps[key] > 0) {
                    player.powerUps[key]--;
                }
            });
            
            // æ²»ç–—å…‰ç¯æ•ˆæœ
            if (player.powerUps.regen > 0 && gameTime % 30 === 0) {
                player.health = Math.min(player.health + 2, player.maxHealth);
            }
            
            // ç©å®¶ç§»åŠ¨
            let currentSpeed = player.speed;
            if (player.slowedUntil > gameTime) {
                currentSpeed *= player.speedMultiplier;
            }
            
            if (keys['KeyW'] || keys['ArrowUp']) player.y -= currentSpeed;
            if (keys['KeyS'] || keys['ArrowDown']) player.y += currentSpeed;
            if (keys['KeyA'] || keys['ArrowLeft']) player.x -= currentSpeed;
            if (keys['KeyD'] || keys['ArrowRight']) player.x += currentSpeed;
            
            player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
            player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));
            
            player.angle = Math.atan2(mouseY - player.y, mouseX - player.x);
            
            // å°„å‡»é€»è¾‘
            if (autoShoot || mouseDown) {
                shoot();
            }
            
            // è£…å¼¹é€»è¾‘
            if (player.reloading) {
                player.reloadTime--;
                if (player.reloadTime <= 0) {
                    player.ammo = player.maxAmmo;
                    player.reloading = false;
                    player.autoReloading = false;
                }
            }
            
            // æ›´æ–°å­å¼¹
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.x += bullet.vx;
                bullet.y += bullet.vy;
                bullet.life--;
                
                if (bullet.life <= 0 || bullet.x < 0 || bullet.x > canvas.width || 
                    bullet.y < 0 || bullet.y > canvas.height) {
                    bullets.splice(i, 1);
                }
            }
            
            // æ›´æ–°æ•Œäººå­å¼¹
            for (let i = enemyBullets.length - 1; i >= 0; i--) {
                const bullet = enemyBullets[i];
                bullet.x += bullet.vx;
                bullet.y += bullet.vy;
                bullet.life--;
                
                if (bullet.life <= 0 || bullet.x < 0 || bullet.x > canvas.width || 
                    bullet.y < 0 || bullet.y > canvas.height) {
                    enemyBullets.splice(i, 1);
                    continue;
                }
                
                // æ£€æŸ¥ä¸ç©å®¶ç¢°æ’
                const dist = Math.sqrt((bullet.x - player.x) ** 2 + (bullet.y - player.y) ** 2);
                if (dist < bullet.size + player.size && player.powerUps.invulnerable === 0) {
                    player.health -= bullet.damage;
                    createParticles(bullet.x, bullet.y, '#ff0000', 8);
                    enemyBullets.splice(i, 1);
                    
                    if (player.health <= 0) {
                        gameOver();
                    }
                }
            }
            
            // æ›´æ–°çˆ†ç‚¸
            for (let i = explosions.length - 1; i >= 0; i--) {
                const explosion = explosions[i];
                explosion.radius += explosion.maxRadius / 30;
                explosion.life--;
                
                if (explosion.life <= 0) {
                    explosions.splice(i, 1);
                    continue;
                }
                
                // æ£€æŸ¥çˆ†ç‚¸ä¼¤å®³
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    const dist = Math.sqrt((enemy.x - explosion.x) ** 2 + (enemy.y - explosion.y) ** 2);
                    
                    if (dist < explosion.radius + enemy.size) {
                        enemy.health -= explosion.damage;
                        createParticles(enemy.x, enemy.y, '#ff6600', 8);
                        
                        if (enemy.health <= 0) {
                            score += enemy.score;
                            kills++;
                            gainExp(enemy.exp);
                            dropItem(enemy.x, enemy.y, enemy.isBoss);
                            createParticles(enemy.x, enemy.y, '#ffff00', enemy.isBoss ? 20 : 12);
                            enemies.splice(j, 1);
                        }
                    }
                }
            }
            
            // æ›´æ–°å†²å‡»æ³¢
            for (let i = shockwaves.length - 1; i >= 0; i--) {
                const shockwave = shockwaves[i];
                shockwave.radius += shockwave.maxRadius / 60;
                shockwave.life--;
                
                if (shockwave.life <= 0) {
                    shockwaves.splice(i, 1);
                    continue;
                }
                
                // æ£€æŸ¥å†²å‡»æ³¢å¯¹ç©å®¶çš„å½±å“
                const dist = Math.sqrt((player.x - shockwave.x) ** 2 + (player.y - shockwave.y) ** 2);
                if (dist < shockwave.radius + player.size && dist > shockwave.radius - 10) {
                    if (player.powerUps.invulnerable === 0) {
                        player.health -= shockwave.damage;
                        player.slowedUntil = gameTime + shockwave.slowDuration;
                        player.speedMultiplier = 0.3;
                        createParticles(player.x, player.y, '#ff00ff', 10);
                        
                        if (player.health <= 0) {
                            gameOver();
                        }
                    }
                }
            }
            
            // æ›´æ–°æ•Œäºº
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                
                // æ—¶é—´å‡é€Ÿæ•ˆæœ
                let enemySpeedMultiplier = 1.0;
                if (player.powerUps.timeSlow > 0) {
                    enemySpeedMultiplier = 0.3;
                }
                
                // å¤§Bossæ— æ•Œåˆ¤æ–­
                if (enemy.isMegaBoss && enemy.health < enemy.maxHealth * 0.2 && !enemy.isInvulnerable) {
                    enemy.isInvulnerable = true;
                    enemy.invulnerableUntil = gameTime + 180; // 3ç§’æ— æ•Œ
                }
                
                if (enemy.invulnerableUntil > 0 && gameTime >= enemy.invulnerableUntil) {
                    enemy.isInvulnerable = false;
                    enemy.invulnerableUntil = 0;
                }
                
                // Bossç‰¹æ®ŠæŠ€èƒ½
                if (enemy.isMegaBoss && Math.random() < 0.01) {
                    useBossSpecial(enemy);
                }
                
                // Bosså†²å‡»æ³¢æ”»å‡»
                if (enemy.canShockwave && Math.random() < 0.005) {
                    bossShockwave(enemy);
                }
                
                // Bosså†²åˆºé€»è¾‘
                if (enemy.canDash && !enemy.isDashing && Date.now() - enemy.lastDash > enemy.dashCooldown) {
                    const distToPlayer = Math.sqrt((enemy.x - player.x) ** 2 + (enemy.y - player.y) ** 2);
                    if (distToPlayer < 200 && Math.random() < 0.3) {
                        enemy.isDashing = true;
                        enemy.dashTime = 30;
                        enemy.lastDash = Date.now();
                    }
                }
                
                // ç§»åŠ¨é€»è¾‘
                const angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                let moveSpeed = enemy.speed * enemySpeedMultiplier;
                
                if (enemy.isDashing) {
                    moveSpeed *= 4;
                    enemy.dashTime--;
                    if (enemy.dashTime <= 0) {
                        enemy.isDashing = false;
                    }
                }
                
                enemy.x += Math.cos(angle) * moveSpeed;
                enemy.y += Math.sin(angle) * moveSpeed;
                
                // å°„å‡»é€»è¾‘
                if (enemy.canShoot && Date.now() - enemy.lastShot > (enemy.isBoss ? 1000 : 2000)) {
                    enemy.lastShot = Date.now();
                    enemyShoot(enemy);
                }
                
                // æ£€æŸ¥ä¸ç©å®¶ç¢°æ’
                const dist = Math.sqrt((enemy.x - player.x) ** 2 + (enemy.y - player.y) ** 2);
                if (dist < enemy.size + player.size && player.powerUps.invulnerable === 0) {
                    const settings = difficultySettings[currentDifficulty];
                    let damage = enemy.damage;
                    
                    if (enemy.isDashing) {
                        damage *= settings.dashDamageMultiplier;
                    }
                    
                    if (!enemy.lastHitTime || Date.now() - enemy.lastHitTime > 1000) {
                        player.health -= damage;
                        enemy.lastHitTime = Date.now();
                        createParticles(enemy.x, enemy.y, '#ff0000', 10);
                    }
                    
                    if (!enemy.isBoss) {
                        enemies.splice(i, 1);
                    }
                    
                    if (player.health <= 0) {
                        gameOver();
                    }
                    continue;
                }
                
                // æ£€æŸ¥ä¸å­å¼¹ç¢°æ’
                for (let j = bullets.length - 1; j >= 0; j--) {
                    const bullet = bullets[j];
                    const bulletDist = Math.sqrt((bullet.x - enemy.x) ** 2 + (bullet.y - enemy.y) ** 2);
                    
                    if (bulletDist < bullet.size + enemy.size) {
                        if (!enemy.isInvulnerable) {
                            enemy.health -= bullet.damage;
                            createParticles(enemy.x, enemy.y, enemy.color, 5);
                        }
                        
                        if (!bullet.piercing) {
                            bullets.splice(j, 1);
                        }
                        
                        if (enemy.health <= 0) {
                            score += enemy.score;
                            kills++;
                            gainExp(enemy.exp);
                            dropItem(enemy.x, enemy.y, enemy.isBoss);
                            createParticles(enemy.x, enemy.y, '#ffff00', enemy.isBoss ? 20 : 12);
                            enemies.splice(i, 1);
                        }
                        break;
                    }
                }
            }
            
            // æ›´æ–°ç‰©å“
            for (let i = items.length - 1; i >= 0; i--) {
                const item = items[i];
                item.life--;
                item.blinkTimer++;
                
                const dist = Math.sqrt((item.x - player.x) ** 2 + (item.y - player.y) ** 2);
                if (dist < item.size + player.size) {
                    if (item.isPowerUp) {
                        usePowerUp(item.type);
                    } else {
                        switch(item.type) {
                            case 'health':
                                player.health = Math.min(player.health + 30, player.maxHealth);
                                break;
                            case 'ammo':
                                player.ammo = Math.min(player.ammo + 15, player.maxAmmo);
                                break;
                            case 'exp':
                                gainExp(25);
                                break;
                        }
                    }
                    createParticles(item.x, item.y, '#00ff00', 8);
                    items.splice(i, 1);
                } else if (item.life <= 0) {
                    items.splice(i, 1);
                }
            }
            
            // æ›´æ–°ç²’å­
            for (let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.vx *= 0.98;
                particle.vy *= 0.98;
                particle.life--;
                particle.size *= 0.95;
                
                if (particle.life <= 0 || particle.size < 0.5) {
                    particles.splice(i, 1);
                }
            }
            
            updateUI();
        }
        
        // æ¸²æŸ“
        function render() {
            ctx.fillStyle = '#001122';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = '#004466';
            ctx.lineWidth = 1;
            for (let x = 0; x < canvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶å†²å‡»æ³¢
            shockwaves.forEach(shockwave => {
                ctx.strokeStyle = shockwave.color;
                ctx.lineWidth = 3;
                ctx.globalAlpha = shockwave.life / 60;
                ctx.beginPath();
                ctx.arc(shockwave.x, shockwave.y, shockwave.radius, 0, Math.PI * 2);
                ctx.stroke();
                ctx.globalAlpha = 1;
            });
            
            // ç»˜åˆ¶çˆ†ç‚¸
            explosions.forEach(explosion => {
                ctx.fillStyle = '#ff6600';
                ctx.globalAlpha = explosion.life / 30;
                ctx.beginPath();
                ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });
            
            // å…ˆç»˜åˆ¶ç²’å­ï¼ˆåœ¨é“å…·ä¸‹å±‚ï¼‰
            particles.forEach(particle => {
                ctx.globalAlpha = particle.life / 30;
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });
            
            // ç»˜åˆ¶ç‰©å“ï¼ˆåœ¨ç²’å­ä¸Šå±‚ï¼‰
            items.forEach(item => {
                let shouldRender = true;
                
                // å³å°†æ¶ˆå¤±æ—¶é—ªçƒæ•ˆæœ
                if (item.life < 180) { // æœ€å3ç§’é—ªçƒ
                    shouldRender = Math.floor(item.blinkTimer / 10) % 2 === 0;
                }
                
                if (shouldRender) {
                    if (item.isPowerUp) {
                        const powerUp = powerUpTypes[item.type];
                        
                        // ç»˜åˆ¶èƒŒæ™¯åœ†åœˆ
                        ctx.fillStyle = powerUp.color;
                        ctx.globalAlpha = 0.8;
                        ctx.beginPath();
                        ctx.arc(item.x, item.y, item.size, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.globalAlpha = 1;
                        
                        // ç»˜åˆ¶è¾¹æ¡†
                        ctx.strokeStyle = '#ffffff';
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.arc(item.x, item.y, item.size, 0, Math.PI * 2);
                        ctx.stroke();
                        
                        // ç»˜åˆ¶emojiå›¾æ ‡
                        ctx.fillStyle = 'black';
                        ctx.font = 'bold 20px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(powerUp.emoji, item.x, item.y);
                        
                        // å‘å…‰æ•ˆæœ
                        if (Math.floor(gameTime / 15) % 2) {
                            ctx.strokeStyle = powerUp.color;
                            ctx.lineWidth = 4;
                            ctx.globalAlpha = 0.6;
                            ctx.beginPath();
                            ctx.arc(item.x, item.y, item.size + 5, 0, Math.PI * 2);
                            ctx.stroke();
                            ctx.globalAlpha = 1;
                        }
                    } else {
                        // æ™®é€šé“å…·
                        const colors = {
                            health: '#ff0066',
                            ammo: '#ffaa00',
                            exp: '#0066ff'
                        };
                        
                        ctx.fillStyle = colors[item.type];
                        ctx.beginPath();
                        ctx.arc(item.x, item.y, item.size, 0, Math.PI * 2);
                        ctx.fill();
                        
                        if (Math.floor(gameTime / 10) % 2) {
                            ctx.strokeStyle = '#ffffff';
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        }
                    }
                }
            });
            
            // ç»˜åˆ¶ç©å®¶ç‰¹æ•ˆ
            renderPlayerEffects();
            
            // ç»˜åˆ¶ç©å®¶
            const playerDrawn = drawSprite('player', player.x, player.y, player.angle, 0.12);

            if (!playerDrawn) {
                // å¦‚æœå›¾ç‰‡æœªåŠ è½½ï¼Œä½¿ç”¨åŸæ¥çš„ç»˜åˆ¶æ–¹å¼
                ctx.save();
                ctx.translate(player.x, player.y);
                ctx.rotate(player.angle);

                // ä¿®æ”¹æ— æ•Œæ—¶çš„ç©å®¶é¢œè‰²ä¸ºé‡‘è‰²
                ctx.fillStyle = player.powerUps.invulnerable > 0 ? '#FFD700' : '#00ff00';
                ctx.beginPath();
                ctx.arc(0, 0, player.size, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(player.size + 5, 0);
                ctx.stroke();

                ctx.restore();
            } else {
                // å¦‚æœä½¿ç”¨å›¾ç‰‡ç»˜åˆ¶ï¼Œåœ¨æ— æ•Œæ—¶æ·»åŠ é‡‘è‰²å…‰æ™•æ•ˆæœ
                if (player.powerUps.invulnerable > 0) {
                    ctx.save();
                    ctx.shadowColor = '#FFD700';
                    ctx.shadowBlur = 15;
                    ctx.globalAlpha = 0.8;
                    drawSprite('player', player.x, player.y, player.angle, 0.12);
                    ctx.restore();
                }
            }
            
            // ç»˜åˆ¶ç©å®¶çŠ¶æ€æ–‡å­—
            renderPlayerStatusText();
            
            // ç»˜åˆ¶å­å¼¹
            bullets.forEach(bullet => {
                // ç©¿é€å¼¹ä½¿ç”¨æ›´æ˜æ˜¾çš„é¢œè‰²
                if (bullet.piercing) {
                    ctx.fillStyle = '#ff00ff'; // æ˜äº®çš„ç´«çº¢è‰²
                    ctx.shadowColor = '#ff00ff';
                    ctx.shadowBlur = 5;
                } else {
                    ctx.fillStyle = bullet.color;
                }
                
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.size, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.shadowBlur = 0;
            });
            
            // ç»˜åˆ¶æ•Œäººå­å¼¹
            enemyBullets.forEach(bullet => {
                ctx.fillStyle = bullet.color;
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.size, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // ç»˜åˆ¶æ•Œäºº
            enemies.forEach(enemy => {
                let spriteKey = 'basicEnemy'; // é»˜è®¤ç²¾çµ
                let scale = 1.0;

                // æ ¹æ®æ•Œäººç±»å‹é€‰æ‹©å¯¹åº”çš„ç²¾çµå’Œç¼©æ”¾æ¯”ä¾‹
                switch(enemy.type) {
                    case 'boss':
                        spriteKey = 'boss';
                        scale = 0.2; // Bosså›¾ç‰‡è¾ƒå¤§ï¼Œç¼©å°åˆ°åˆé€‚å°ºå¯¸
                        break;
                    case 'megaBoss':
                        spriteKey = 'megaBoss';
                        scale = 0.3; // è¶…çº§Bossç¨å¤§ä¸€äº›
                        break;
                    case 'fast':
                        spriteKey = 'fastEnemy';
                        scale = 0.15; // å¿«é€Ÿæ•Œäººè¾ƒå°
                        break;
                    case 'tank':
                        spriteKey = 'tankEnemy';
                        scale = 0.18; // å¦å…‹æ•Œäººä¸­ç­‰å¤§å°
                        break;
                    case 'shooter':
                        spriteKey = 'basicEnemy';
                        scale = 0.16; // å°„å‡»æ•Œäººä¸­ç­‰å¤§å°
                        break;
                    default:
                        spriteKey = 'basicEnemy';
                        scale = 0.16; // åŸºç¡€æ•Œäººä¸­ç­‰å¤§å°
                }

                // Bosså‘å…‰æ•ˆæœ
                if (enemy.isBoss) {
                    ctx.shadowColor = enemy.isMegaBoss ? '#ff00ff' : '#ff0000';
                    ctx.shadowBlur = 20;
                }

                // å°è¯•ç»˜åˆ¶ç²¾çµå›¾ç‰‡
                const enemyDrawn = drawSprite(spriteKey, enemy.x, enemy.y, 0, scale);

                if (!enemyDrawn) {
                    // å¦‚æœå›¾ç‰‡æœªåŠ è½½ï¼Œä½¿ç”¨åŸæ¥çš„ç»˜åˆ¶æ–¹å¼
                    // å†²åˆºæ•ˆæœ
                    if (enemy.isDashing) {
                        ctx.fillStyle = '#ffffff';
                    } else {
                        ctx.fillStyle = enemy.color;
                    }

                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y, enemy.size, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.shadowBlur = 0;
                
                // æ¸²æŸ“Bossç‰¹æ•ˆ
                if (enemy.isBoss) {
                    renderBossEffects(enemy);
                }
                
                // Bossæ ‡è®°
                if (enemy.isBoss) {
                    ctx.strokeStyle = enemy.isMegaBoss ? '#ff00ff' : '#ffff00';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y, enemy.size + 8, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                // è¡€æ¡
                if (enemy.health < enemy.maxHealth) {
                    const barWidth = enemy.size * 2;
                    const barHeight = 6;
                    const healthPercent = enemy.health / enemy.maxHealth;
                    
                    ctx.fillStyle = '#ff0000';
                    ctx.fillRect(enemy.x - barWidth/2, enemy.y - enemy.size - 12, barWidth, barHeight);
                    
                    ctx.fillStyle = enemy.isInvulnerable ? '#white' : '#00ff00';
                    ctx.fillRect(enemy.x - barWidth/2, enemy.y - enemy.size - 12, barWidth * healthPercent, barHeight);
                }
            });
            
            // è£…å¼¹æç¤º
            if (player.reloading) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.font = '24px Courier New';
                ctx.textAlign = 'center';
                const progress = (60 - player.reloadTime) / 60;
                ctx.fillText(`è£…å¼¹ä¸­... ${Math.floor(progress * 100)}%`, canvas.width / 2, canvas.height / 2);
            }
        }
        
        // æ›´æ–°UI
        function updateUI() {
            document.getElementById('level').textContent = player.level;
            document.getElementById('score').textContent = score;
            document.getElementById('kills').textContent = kills;
            document.getElementById('wave').textContent = wave;
            document.getElementById('currentDifficulty').textContent = difficultySettings[currentDifficulty].name;
            document.getElementById('bombCount').textContent = player.bombCount;
            document.getElementById('shootMode').textContent = autoShoot ? 'ğŸ¯ å°„å‡»: è‡ªåŠ¨æ¨¡å¼' : 'ğŸ¯ å°„å‡»: æ‰‹åŠ¨æ¨¡å¼';
            
            const healthPercent = (player.health / player.maxHealth) * 100;
            document.getElementById('healthBar').style.width = healthPercent + '%';
            document.getElementById('healthText').textContent = Math.floor(player.health) + '/' + player.maxHealth;
            
            const expNeeded = player.level * 100;
            const expPercent = (player.exp / expNeeded) * 100;
            document.getElementById('expBar').style.width = expPercent + '%';
            document.getElementById('expText').textContent = player.exp + '/' + expNeeded;
            
            const ammoPercent = (player.ammo / player.maxAmmo) * 100;
            document.getElementById('ammoBar').style.width = ammoPercent + '%';
            document.getElementById('ammoText').textContent = player.ammo + '/' + player.maxAmmo;
            
            // è£…å¼¹çŠ¶æ€
            const reloadStatus = document.getElementById('reloadStatus');
            if (player.reloading) {
                reloadStatus.textContent = '(è£…å¼¹ä¸­...)';
                reloadStatus.style.color = '#ffaa00';
            } else if (player.ammo === 0) {
                reloadStatus.textContent = '(æ— å¼¹è¯!)';
                reloadStatus.style.color = '#ff0000';
            } else {
                reloadStatus.textContent = '';
            }
            
            Object.keys(player.attributes).forEach(attr => {
                const element = document.getElementById(attr + 'Level');
                if (element) element.textContent = player.attributes[attr];
            });
            
            document.getElementById('skillPoints').textContent = player.skillPoints;
            document.getElementById('weaponType').textContent = weapons[player.weaponType].name;
            
            // å‡çº§æŒ‰é’®
            const upgradeToggle = document.getElementById('upgradeToggle');
            if (player.skillPoints > 0) {
                upgradeToggle.classList.add('has-points');
                upgradeToggle.textContent = `å‡çº§é¢æ¿ (${player.skillPoints})`;
            } else {
                upgradeToggle.classList.remove('has-points');
                upgradeToggle.textContent = 'å‡çº§é¢æ¿';
            }
            
            document.querySelectorAll('.upgrade-btn').forEach((btn, index) => {
                const attrs = ['damage', 'health', 'fireRate', 'speed', 'ammo'];
                const attr = attrs[index];
                btn.disabled = player.skillPoints < 5 || player.attributes[attr] >= 10;
            });
        }
        
        function gameOver() {
            gameRunning = false;
            document.getElementById('finalLevel').textContent = player.level;
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalKills').textContent = kills;
            document.getElementById('finalWave').textContent = wave;
            document.getElementById('finalDifficulty').textContent = difficultySettings[currentDifficulty].name;
            document.getElementById('gameOver').style.display = 'block';
        }
        
        function restartGame() {
            gameRunning = false;
            gamePaused = false;
            gameTime = 0;
            upgradeVisible = false;
            
            player = {
                x: 500,
                y: 350,
                size: 15,
                health: 100,
                maxHealth: 100,
                speed: 3,
                angle: 0,
                exp: 0,
                level: 1,
                skillPoints: 0,
                ammo: 30,
                maxAmmo: 30,
                reloading: false,
                reloadTime: 0,
                autoReloading: false,
                lastShot: 0,
                fireRate: 200,
                damage: 20,
                weaponType: 0,
                bombCount: 0,
                slowedUntil: 0,
                speedMultiplier: 1.0,
                attributes: {
                    damage: 1,
                    health: 1,
                    fireRate: 1,
                    speed: 1,
                    ammo: 1
                },
                powerUps: {
                    invulnerable: 0,
                    timeSlow: 0,
                    doubleFire: 0,
                    piercing: 0,
                    regen: 0
                }
            };
            
            enemies = [];
            enemyBullets = [];
            bullets = [];
            items = [];
            particles = [];
            explosions = [];
            shockwaves = [];
            
            score = 0;
            kills = 0;
            wave = 1;
            waveProgress = 0;
            
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('rightPanel').style.display = 'none';
            document.getElementById('pauseOverlay').style.display = 'none';
            document.getElementById('difficultySelect').style.display = 'flex';
            
            updateUI();
        }
        
        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }
        
        init();
    </script>
</body>
</html>
